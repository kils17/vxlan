<config-template xmlns="http://tail-f.com/ns/config/1.0">
  <devices xmlns="http://tail-f.com/ns/ncs">
    <device>
      <!--
          bdr-switch config
      -->
      <name>{/bdr-sw/switch}</name>
      <config>
        <vlan xmlns="http://tail-f.com/ned/cisco-nx">
          <vlan-list>
            <id>{/l3-vlanid}</id>
            <name>L3-VNI-{/l3-vlanid}-Tenant-{/name}</name>
            <vn-segment>{/vnid-prefix}{/l3-vlanid}</vn-segment>
          </vlan-list>
        </vlan>
        <route-map xmlns="http://tail-f.com/ned/cisco-nx">
          <name>permitall</name>
          <sequence>10</sequence>
          <operation>permit</operation>
        </route-map>
        <vrf xmlns="http://tail-f.com/ned/cisco-nx">
          <context>
            <id>Tenant-{/name}</id>
            <vni>{/vnid-prefix}{/l3-vlanid}</vni>
            <rd>auto</rd>
            <address-family>
              <ipv4>
                <unicast>
                  <route-target>
                    <method>both</method>
                    <asn>auto</asn>
                    <target-evpn>evpn</target-evpn>
                  </route-target>
                  <route-target>
                    <method>both</method>
                    <asn>auto</asn>
                    <target-evpn>non-evpn</target-evpn>
                  </route-target>
                </unicast>
              </ipv4>
            </address-family>
          </context>
        </vrf>
        <interface xmlns="http://tail-f.com/ned/cisco-nx">
          <Vlan>
            <name>{/l3-vlanid}</name>
            <vrf>
              <member>Tenant-{/name}</member>
            </vrf>
            <ip>
              <forward/>
            </ip>
          </Vlan>
          <nve>
            <name>1</name>
            <member>
              <vni>
                <id>{/vnid-prefix}{/l3-vlanid}</id>
                <associate-vrf/>
              </vni>
            </member>
          </nve>
        </interface>
        <router xmlns="http://tail-f.com/ned/cisco-nx">
          <bgp>
            <id>{/asn}</id>
            <vrf>
              <name>Tenant-{/name}</name>
              <address-family>
                <proto>ipv4</proto>
                <type>unicast</type>
                <redistribute>
                  <direct>
                    <route-map>permitall</route-map>
                  </direct>
                </redistribute>
              </address-family>
            </vrf>
          </bgp>
        </router>
      </config>
    </device>

    <device>
      <!--
          leaf-switch config
      -->
      <name>{/leaf-sw/switch}</name>
      <config>
        <vlan xmlns="http://tail-f.com/ned/cisco-nx">
          <vlan-list>
            <id>{/l2-vni/vlan-id}</id>
            <name>L2-VNI-{/l2-vni/vlan-id}-Tenant-{/name}</name>
            <vn-segment>{/vnid-prefix}{/l2-vni/vlan-id}</vn-segment>
          </vlan-list>
          <vlan-list>
            <id>{/l3-vlanid}</id>
            <name>L3-VNI-{/l3-vlanid}-Tenant-{/name}</name>
            <vn-segment>{/vnid-prefix}{/l3-vlanid}</vn-segment>
          </vlan-list>
        </vlan>
        <evpn xmlns="http://tail-f.com/ned/cisco-nx">
          <vni>
            <id>{/vnid-prefix}{/l2-vni/vlan-id}</id>
            <l2/>
            <rd>auto</rd>
            <route-target>
              <method>import</method>
              <rt>auto</rt>
            </route-target>
            <route-target>
              <method>export</method>
              <rt>auto</rt>
            </route-target>
          </vni>
        </evpn>
        <route-map xmlns="http://tail-f.com/ned/cisco-nx">
          <name>permitall</name>
          <sequence>10</sequence>
          <operation>permit</operation>
        </route-map>
        <vrf xmlns="http://tail-f.com/ned/cisco-nx">
          <context>
            <id>Tenant-{/name}</id>
            <vni>{/vnid-prefix}{/l3-vlanid}</vni>
            <rd>auto</rd>
            <address-family>
              <ipv4>
                <unicast>
                  <route-target>
                    <method>both</method>
                    <asn>auto</asn>
                    <target-evpn>evpn</target-evpn>
                  </route-target>
                  <route-target>
                    <method>both</method>
                    <asn>auto</asn>
                    <target-evpn>non-evpn</target-evpn>
                  </route-target>
                </unicast>
              </ipv4>
            </address-family>
          </context>
        </vrf>
        <interface xmlns="http://tail-f.com/ned/cisco-nx">
          <Vlan>
            <name>{/l2-vni/vlan-id}</name>
            <vrf>
              <member>Tenant-{/name}</member>
            </vrf>
            <ip>
              <address>
                <ipaddr>{/l2-vni/svi-ipaddr}</ipaddr>
              </address>
              <redirects>false</redirects>
            </ip>
            <fabric>
              <forwarding>
                <mode>anycast-gateway</mode>
              </forwarding>
            </fabric>
          </Vlan>
          <Vlan>
            <name>{/l3-vlanid}</name>
            <vrf>
              <member>Tenant-{/name}</member>
            </vrf>
            <ip>
              <forward/>
            </ip>
          </Vlan>
          <nve>
            <name>1</name>
            <member>
              <vni>
                <id>{/vnid-prefix}{/l2-vni/vlan-id}</id>
                <mcast-group>239.0.0.{/l2-vni/vlan-id}</mcast-group>
              </vni>
              <vni>
                <id>{/vnid-prefix}{/l3-vlanid}</id>
                <associate-vrf/>
              </vni>
            </member>
          </nve>
          <Ethernet>
            <name>{/leaf-sw/leaf-port/port}</name>
            <switchport>
              <access>
                <vlan>{/l2-vni/vlan-id}</vlan>
              </access>
            </switchport>
            <spanning-tree>
              <port>
                <type>edge</type>
              </port>
            </spanning-tree>
          </Ethernet>
        </interface>
        <router xmlns="http://tail-f.com/ned/cisco-nx">
          <bgp>
            <id>{/asn}</id>
            <vrf>
              <name>Tenant-{/name}</name>
              <address-family>
                <proto>ipv4</proto>
                <type>unicast</type>
                <redistribute>
                  <direct>
                    <route-map>permitall</route-map>
                  </direct>
                </redistribute>
              </address-family>
            </vrf>
          </bgp>
        </router>
      </config>
    </device>
  </devices>
</config-template>
